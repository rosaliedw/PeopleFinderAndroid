<!--USED TO MOCK SOME DATA -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Faker/3.1.0/faker.js"></script>

<link rel="import" href="/bower_components/polymer/polymer-element.html">

<link rel="import" href="/includes.html">


<dom-module id="search-page">

    <template>
        <style include="custom-styles">
        </style>

<app-location route="{{route}}"></app-location>

<!-- this app-route manages the top-level routes -->
<app-route
    route="{{route}}"
    pattern="/:view"
    data="{{routeData}}"
    tail="{{subroute}}"></app-route>

        <paper-search-bar query="{{searchQuery}}" hide-filter-button="true">
        </paper-search-bar>
        <br>
        <iron-ajax id="personajax" url="http://localhost:8080/person/{{searchQuery}}" method='GET' loading="{{loading}}" handleAs="json"
            on-response="handleResponse">
        </iron-ajax>

        <template is="dom-if" if="{{loading}}">
            <paper-spinner active class="horizontal-center"></paper-spinner>
        </template>
        <template is="dom-if" if="{{!loading}}">
            <dom-repeat items="{{searchResults}}">
                <template>
                    <search-result-element item="[[item]]" on-tap="_goToDetails" cn="[[item.cn]]" department="[[item.department]]" title="[[item.title]]" mobile="[[item.mobile]]">
                    </search-result-element>
                    <br>
                </template>
            </dom-repeat>
        </template>
    </template>

    <script>
        class SearchPage extends Polymer.Element {
            static get is() { return 'search-page'; }
            static get properties() {
                return {
                    loading: {
                        type: Boolean,
                        value: true
                    },
                    searchQuery: {
                        type: String,
                        observer: 'search'
                    },
                    searchResults: {
                        type: Array,
                    },
                    mockData: {
                        type: Array,
                        notify: true,
                        value: []
                    }
                }
            }


            ready() {
                super.ready();
                this.removeAttribute('unresolved');

                //MOCK SOME DATA

                for (var i = 0; i < 100; i++) {

                    this.push('mockData', {
                        cn: faker.name.findName(),
                        department: faker.name.jobArea(),
                        title: faker.name.jobType(),
                        mobile: faker.phone.phoneNumber(),
                        id: faker.helpers.replaceSymbols('??##??')
                    });
                }

                console.log(this.mockData);
                this.searchResults = this.mockData;
            }

            search() {
                if (this.searchQuery.length >= 3) {
                    this.loading = true;
                    this.$.personajax.generateRequest();
                    this.searchResults = [];
                }
                else {
                    this.loading = false;
                }
                if (this.searchQuery.length === 0) {
                    this.searchResults = [];
                }
            }

            handleResponse(e) {
                this.searchResults = e.detail.response;
                
            }

            hasNumber(item) {
                return /\d/.test(item);
            }

            _goToDetails(e) {
                console.log('in gotodetails');
                console.log(e.target.item);

                var el = e.target.item;
                this.set('route.path.cn', el.cn );
                this.set('route.path.uid', el.uid );
                this.set('route.path.department', el.department );                
                this.set('route.path.title', el.title );
                this.set('route.path.mobile', el.mobile );
                this.set('route.path.mail', el.mail );
                this.set('route.path.preferred-language', el.preferredlanguage);
                
                this.set('route.path', '/person-details/'); 
            }



        }
        customElements.define(SearchPage.is, SearchPage);
    </script>

</dom-module>



<person-details-page cn="Yoran Cobben" uid="il79gb" department="NSP" title="uncodified" mobile="0499269024" mail="yoran.cobben@ing.be"
preferred-language="nl"> </person-details-page>